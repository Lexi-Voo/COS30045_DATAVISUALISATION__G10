<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Positive Drug Tests by Age Group</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        #chart {
            margin: 20px 0;
        }
        .bar {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .bar:hover {
            opacity: 0.8;
        }
        .axis-label {
            font-size: 14px;
            font-weight: 600;
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }
        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Drug Detection by Age Demographics</h1>
        <div class="subtitle">Distribution of Positive Drug Test Results Across Different Age Groups</div>
        <div id="chart"></div>
        <div class="stats-grid" id="stats"></div>
    </div>
    <div class="tooltip" id="tooltip"></div>

    <script>
        // Data from positive_by_age.csv
        const data = [
            { ageGroup: "0-16", count: 240 },
            { ageGroup: "17-25", count: 2074 },
            { ageGroup: "26-39", count: 2346 },
            { ageGroup: "40-64", count: 2065 },
            { ageGroup: "65 and over", count: 612 },
            { ageGroup: "All ages", count: 112 },
            { ageGroup: "Unknown", count: 533 }
        ];

        const margin = { top: 20, right: 30, bottom: 80, left: 80 };
        const width = 900 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;

        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleBand()
            .domain(data.map(d => d.ageGroup))
            .range([0, width])
            .padding(0.2);

        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.count) * 1.1])
            .range([height, 0]);

        const colorScale = d3.scaleOrdinal()
            .domain(data.map(d => d.ageGroup))
            .range(['#667eea', '#764ba2', '#f093fb', '#f5576c', '#43e97b', '#feca57', '#ff6b6b']);

        // Add X axis
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "rotate(-45)")
            .style("text-anchor", "end")
            .style("font-size", "12px")
            .style("font-weight", "500");

        // Add Y axis
        svg.append("g")
            .call(d3.axisLeft(y).ticks(8))
            .selectAll("text")
            .style("font-size", "12px");

        // Y axis label
        svg.append("text")
            .attr("class", "axis-label")
            .attr("transform", "rotate(-90)")
            .attr("y", -60)
            .attr("x", -height / 2)
            .attr("text-anchor", "middle")
            .text("Number of Positive Tests");

        // X axis label
        svg.append("text")
            .attr("class", "axis-label")
            .attr("y", height + 70)
            .attr("x", width / 2)
            .attr("text-anchor", "middle")
            .text("Age Group");

        const tooltip = d3.select("#tooltip");

        // Add bars with animation
        svg.selectAll(".bar")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("x", d => x(d.ageGroup))
            .attr("width", x.bandwidth())
            .attr("y", height)
            .attr("height", 0)
            .attr("fill", d => colorScale(d.ageGroup))
            .attr("rx", 4)
            .on("mouseover", function(event, d) {
                const total = d3.sum(data, d => d.count);
                const percentage = ((d.count / total) * 100).toFixed(1);
                tooltip.style("opacity", 1)
                    .html(`<strong>${d.ageGroup}</strong><br/>Positive Tests: ${d.count.toLocaleString()}<br/>Percentage: ${percentage}%`);
            })
            .on("mousemove", function(event) {
                tooltip.style("left", (event.pageX + 15) + "px")
                    .style("top", (event.pageY - 15) + "px");
            })
            .on("mouseout", function() {
                tooltip.style("opacity", 0);
            })
            .transition()
            .duration(800)
            .delay((d, i) => i * 100)
            .attr("y", d => y(d.count))
            .attr("height", d => height - y(d.count));

        // Add value labels on top of bars
        svg.selectAll(".label")
            .data(data)
            .enter()
            .append("text")
            .attr("class", "label")
            .attr("x", d => x(d.ageGroup) + x.bandwidth() / 2)
            .attr("y", height)
            .attr("text-anchor", "middle")
            .style("font-size", "12px")
            .style("font-weight", "600")
            .style("fill", "#2d3748")
            .style("opacity", 0)
            .text(d => d.count.toLocaleString())
            .transition()
            .duration(800)
            .delay((d, i) => i * 100)
            .attr("y", d => y(d.count) - 8)
            .style("opacity", 1);

        // Calculate statistics
        const total = d3.sum(data, d => d.count);
        const highestGroup = data.reduce((max, d) => d.count > max.count ? d : max, data[0]);
        const avgCount = (total / data.length).toFixed(0);
        const youngDrivers = data.filter(d => d.ageGroup === "17-25" || d.ageGroup === "0-16")
            .reduce((sum, d) => sum + d.count, 0);
        const youngPercentage = ((youngDrivers / total) * 100).toFixed(1);

        // Display statistics
        const stats = [
            { label: "Total Positive Tests", value: total.toLocaleString() },
            { label: "Highest Risk Group", value: highestGroup.ageGroup },
            { label: "Young Drivers (0-25)", value: `${youngPercentage}%` },
            { label: "Average per Group", value: avgCount }
        ];

        d3.select("#stats")
            .selectAll(".stat-card")
            .data(stats)
            .enter()
            .append("div")
            .attr("class", "stat-card")
            .style("opacity", 0)
            .html(d => `<div class="stat-label">${d.label}</div><div class="stat-value">${d.value}</div>`)
            .transition()
            .duration(600)
            .delay((d, i) => 1000 + i * 100)
            .style("opacity", 1);
    </script>
</body>
</html>